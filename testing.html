<!doctype html>
<html lang="en">
<head>
  <title>Heap Router Issue Repro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="content-type" content="charset=UTF8">
</head>
<body>
<div id="app">
  <div id="loader">
    Heap ID: <input type="text" id="heap-id-field" value="405057187" />
    <button id="heap-load-button">Load heap</buttoz>
  </div>
  <hr />
  <div class="controls">
    <button disabled id="async-redirect-blast">Asynchronous redirect blast</button>
    <!--
    <button disabled id="sync-redirect-blast">Synchronous redirect blast</button>
    -->
    <button id="clear-log">Clear log</button>
  </div>
  <hr />
  <div id="log"></div>
</div>

<script type="text/javascript">
  const path = new URL(document.location).pathname

  /**
   * Load Heap using the provided account id. Fill in your own Heap ID if you
   * want to see the events come in on your own Heap account.
   */
  function loadHeap (id) {
        window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=document.createElement("script");r.type="text/javascript",r.async=!0,r.src="https://cdn.heapanalytics.com/js/heap-"+e+".js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(r,a);for(var n=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","resetIdentity","removeEventProperty","setEventProperties","track","unsetEventProperty"],o=0;o<p.length;o++)heap[p[o]]=n(p[o])};   
    heap.load(id); 
    heap.identify('repro-test-user')
  }

  /**
   * Convenience function for spinning the event loop for a number of
   * milliseconds.
   */
  function wait (ms) {
    return new Promise(resolve => setTimeout(resolve, ms))
  }

  /**
   * Triggers a series of redirects using `history.pushState`. If a delay is
   * provided, it will wait (at least) that number of milliseconds between
   * pushState calls.
   */

   var ringURLs = [
      "account/plan/devices/djn11j-1a61k-0/yearly",
      "account/plan/payment/djn11j-1a61k-0/yearly",
      "account/plan/devices/djn11j-1a61k-0/monthly",
      "account/plan/payment/djn11j-1a61k-0/monthly",
      "account/plan/payment/djn11j-1a61k-0/multicam_yearly",
      "account/plan/payment/djn11j-1a61k-0/multicam_monthly",
      "account/app/location/djn11j-1a61k-0/devices",
      "account/app/location/djn11j-1a61k-0/settings",
      "account/app/location/djn11j-1a61k-0/settings/users",
      "account/app/location/djn11j-1a61k-0/settings/modes",
      "account/app/location/djn11j-1a61k-0/edit",
      "account/app/location/djn11j-1a61k-0/settings/alerts",
      "account/app/location/djn11j-1a61k-0/monitoring/signup/emergency-contact",
      "account/app/location/djn11j-1a61k-0/settings/users/choose-type",
      "account/app/location/djn11j-1a61k-0/settings/modes/all",
      "account/app/location/djn11j-1a61k-0/settings/modes/some",
      "account/app/location/djn11j-1a61k-0/monitoring/signup/terms",
      "account/app/location/djn11j-1a61k-0/settings/users/add-shared",
      "account/app/location/djn11j-1a61k-0/settings/modes/none",
      "account/app/location/djn11j-1a61k-0/settings/users/add-guest",
      "account/app/location/djn11j-1a61k-0/monitoring/signup/residence-type",
      "account/app/location/djn11j-1a61k-0/monitoring/signup/cross-street",
      "account/app/location/djn11j-1a61k-0/edit/country",
      "account/app/location/djn11j-1a61k-0/monitoring/signup/skip-setup",
      "account/app/location/djn11j-1a61k-0/monitoring/signup/residence-type/learn-more",
      "account/app/plans/subscribe/djn11j-1a61k-0",
      "account/app/plans/upgrade/djn11j-1a61k-0",
      "account/app/plans/cancel/djn11j-1a61k-0",
      "account/app/plans/remove/djn11j-1a61k-0",
      "account/app/location/djn11j-1a61k-0",
      "account/plan/location/djn11j-1a61k-0",
      "account/plan/confirmation/djn11j-1a61k-0",
      "cases/14810",
      "alerts/2308641",
      "share/6779325922187571491",
      "user/viewprofilepage/user-id/6776693772964037722",
      "{{shopify store id}}/orders/ebc741d2818b4e52d034bed1e90d8232",
      "{{shopify store id}}/checkouts/6914341426c9d300552f143f7e1ddf2d",
      //Query Parameters
      "account/activity-history?l=djn11j-1a61k-0",
      "account/dashboard?l=djn11j-1a61k-0",
      "account/attach/review?plan=basic&provider=provider_id&location=djn11j-1a61k-0&devices=31208385",
      "checkout/contact_information?PayerID=BZZX9MTZZEZS4&token=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoyMjg1NjA4MCwidXNlcl9lbWFpbCI6Implbm55c2hlbkB3aW5kb3dzbGl2ZS5jb20iLCJ1c2VyX3N0YXR1cyI6InVudmVyaWZpZWQiLCJhcHBfYnJhbmQiOiJkb29yYm90Iiwib3MiOiJyaW5nLXNpdGUiLCJleHAiOjE1NzUzNjA0NjR9.5uO6B8RX_XoP56QT7PzOBMqlXWsarlNTo-ORahWdXcg",
      "users/verify_email?token=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoyMjg1NjA4MCwidXNlcl9lbWFpbCI6Implbm55c2hlbkB3aW5kb3dzbGl2ZS5jb20iLCJ1c2VyX3N0YXR1cyI6InVudmVyaWZpZWQiLCJhcHBfYnJhbmQiOiJkb29yYm90Iiwib3MiOiJyaW5nLXNpdGUiLCJleHAiOjE1NzUzNjA0NjR9.5uO6B8RX_XoP56QT7PzOBMqlXWsarlNTo-ORahWdXcg",
      "mobile/upgrade/?user_email=daniel.rosen@heap.io",
      "checkout/contact_information?checkout[email]=daniel.rosen@heap.io&discount=ABC123&locale=ne",
      "account/purchase/review?locationId=djn11j-1a61k-0&deviceId=31208385&planType=plus&billingFrequency=monthly",
      "invitation/accept?invitation_token=EC-7FF31024LG718241R",
      "?code=1do7r4SAihAzzhk5_u3-wgKTYvVZy1owHe8fksmKakAv1j0PV6app-dQvKKgDPVJPz4D-aSY-A0WBPl-VLTkcg",
      "?code=1do7r4SAihAzzhk5_u3-wgKTYvVZy1owHe8fksmKakAv1j0PV6app-dQvKKgDPVJPz4D-aSY-A0WBPl-VLTkcg"]

  async function redirectBlast (delay) {
    for (let i = 0; i < ringURLs.length; i += 1) {
      history.pushState(null, null, `${path}/${ringURLs[i]}`)
      console.log(`/${ringURLs[i]}`);
      if (delay) {
        await wait(delay)
      }
    }
    history.pushState(null, null, path)
    
  }

  /**
   * Logs a { from, to } object pair to the provided logNode. Used later to
   * render what the Heap javascript client is sending back to its server. 
   */
  function log (logNode, { from, to }) {
    const entry = document.createElement('div')
    entry.innerHTML = `<code>${from}</code> â†’ <code>${to}</code>`

    logNode.appendChild(entry)
  }

  // Grab a bunch of references to DOM nodes, becaues we're about to attach
  // some stuff to them and otherwise bang on them a bit:
  const qs = document.querySelector.bind(document)
  const heapIdField = qs('#heap-id-field')
  const heapLoadButton = qs('#heap-load-button')
  const asyncRedirectBlastButton = qs('#async-redirect-blast')
  const syncRedirectBlastButton = qs('#sync-redirect-blast')
  const logNode = qs('#log')
  const clearLogButton = qs('#clear-log')

  // When the user click's the "Load heap" button, invoke the loadHeap function
  // with the provided Heap account ID, then enable the two redirector buttons
  heapLoadButton.addEventListener('click', () => {
    const id = heapIdField.value
    loadHeap(id)
    
    asyncRedirectBlastButton.disabled = false
    //syncRedirectBlastButton.disabled = false
  })

  asyncRedirectBlastButton.addEventListener('click', () => redirectBlast(2))
  //syncRedirectBlastButton.addEventListener('click', () => redirectBlast())
  clearLogButton.addEventListener('click', () => { logNode.innerHTML = '' })

  // To detect what the Heap client is sending at the server, we are going to
  // use (abuse?) the browser's built-in PerformanceObserver utility. This is
  // usually used to measure how long it takes to peform requests, but it can
  // also be used to see what requests are being made or what resources are
  // being requested. Because Heap sends tracking events via HTTP requests to
  // a gif, we can track and dump those events by watching resource perf events
  // with PerformanceObserver. Neat!
  //
  const observer = new PerformanceObserver((list) => {
    // Any time we get a PerformanceObserver event, we get all the entries that
    // it contains, and then filter down to just the events we care about, 
    // converting them to { from, to } pairs along the way.
    const routeChangesLoggedToHeap = list.getEntries().map(te => {
      const params = (new URL(te.name)).searchParams
      const from = params.get('pr')
      const to = params.get('h')

      if (from && to) return { from, to }
      else return null
    }).filter(Boolean)

    // Once we have { from, to } pairs, log each one to the logger node.
    routeChangesLoggedToHeap.forEach(change => log(logNode, change))
  });

  // Observe any resource load events.
  observer.observe({ entryTypes: ['resource'] })
</script>
</body>
</html>
